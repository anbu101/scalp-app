<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scalp — Pick & Save Strikes</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:18px;background:#f7fafc;color:#0f172a}
    .card{background:white;border:1px solid #e6edf3;padding:14px;border-radius:8px;max-width:980px;margin:0 auto}
    h1{font-size:18px;margin:0 0 12px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input[type=text], input[type=number], textarea {width:100%;padding:8px;border-radius:6px;border:1px solid #d1d9e0}
    .row{display:flex;gap:8px}
    .col{flex:1}
    button{padding:8px 12px;border-radius:6px;border:1px solid #cbd5e1;background:#fff;cursor:pointer}
    pre{background:#0b1220;color:#e6eef8;padding:10px;border-radius:6px;overflow:auto}
    small.note{color:#6b7280}
  </style>
</head>
<body>
  <div class="card">
    <h1>Scalp — Strike Picker & Config Saver</h1>
    <p class="note"><small>Use the controls below to fetch candidate CE/PE strikes (demo GET /api/strikes/pick). For production, replace with your live fetch.</small></p>

    <div style="margin-top:10px">
      <label>Min price (rs)</label>
      <input id="minPrice" type="number" value="100" />
    </div>
    <div style="margin-top:8px">
      <label>Max price (rs)</label>
      <input id="maxPrice" type="number" value="200" />
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <button id="fetchPicks">Fetch Picks (GET /api/strikes/pick)</button>
      <button id="savePicks" disabled>Save Picks to Config</button>
      <button id="loadConfig">Load Config</button>
      <div style="margin-left:8px;color:#6b7280">Backend: <input id="baseUrl" type="text" value="http://localhost:8000" style="width:220px" /></div>
    </div>

    <hr style="margin:12px 0" />

    <div>
      <h3>Picked Results</h3>
      <div style="display:flex;gap:12px">
        <div style="flex:1">
          <strong>CE</strong>
          <pre id="ceBox">-</pre>
        </div>
        <div style="flex:1">
          <strong>PE</strong>
          <pre id="peBox">-</pre>
        </div>
      </div>
    </div>

    <hr style="margin:12px 0" />

    <div>
      <h3>Settings (lots / lot_size)</h3>
      <div class="row" style="margin-bottom:8px">
        <div class="col">
          <label>Lots</label>
          <input id="lots" type="number" value="1" />
        </div>
        <div class="col">
          <label>Lot size</label>
          <input id="lotSize" type="number" value="75" />
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="saveConfigBtn">Save Config</button>
        <button id="showConfigBtn">Show Current Config</button>
      </div>
      <div style="margin-top:10px">
        <strong>Config Output</strong>
        <pre id="configOut">-</pre>
      </div>
    </div>

    <hr style="margin:12px 0" />
    <div>
      <h3>Manual Instruments Input (optional)</h3>
      <label>Paste instruments JSON array (used by POST /api/pick_strikes)</label>
      <textarea id="instruments" rows="6" placeholder='[ { "symbol":"NIFTY-21500CE", "strike":21500, "option_type":"CE", "last_price":180 } ]'></textarea>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="postPickBtn">Pick using POST /api/pick_strikes</button>
      </div>
      <div style="margin-top:8px;color:#6b7280"><small>If you paste instruments, click the POST button — otherwise use the simple GET pick above (demo data).</small></div>
    </div>

  </div>

<script>
(function(){
  const fetchPicks = document.getElementById('fetchPicks')
  const savePicks = document.getElementById('savePicks')
  const loadConfig = document.getElementById('loadConfig')
  const baseUrlEl = document.getElementById('baseUrl')
  const ceBox = document.getElementById('ceBox')
  const peBox = document.getElementById('peBox')
  const minPriceEl = document.getElementById('minPrice')
  const maxPriceEl = document.getElementById('maxPrice')
  const lotsEl = document.getElementById('lots')
  const lotSizeEl = document.getElementById('lotSize')
  const saveConfigBtn = document.getElementById('saveConfigBtn')
  const configOut = document.getElementById('configOut')
  const showConfigBtn = document.getElementById('showConfigBtn')
  const instrumentsTA = document.getElementById('instruments')
  const postPickBtn = document.getElementById('postPickBtn')

  let lastPicks = null

  function getBase(){
    return baseUrlEl.value.trim().replace(/\/$/, '')
  }

  async function doFetchPicks(){
    const base = getBase()
    const minp = Number(minPriceEl.value || 0)
    const maxp = Number(maxPriceEl.value || 9999)
    const url = base + '/api/strikes/pick?min_price=' + encodeURIComponent(minp) + '&max_price=' + encodeURIComponent(maxp)
    ceBox.textContent = 'fetching...'
    peBox.textContent = 'fetching...'
    savePicks.disabled = true
    try{
      const r = await fetch(url)
      if(!r.ok){
        const txt = await r.text()
        ceBox.textContent = 'Error: ' + r.status + '\n' + txt
        peBox.textContent = ''
        return
      }
      const j = await r.json()
      lastPicks = j
      ceBox.textContent = JSON.stringify(j.ce, null, 2)
      peBox.textContent = JSON.stringify(j.pe, null, 2)
      savePicks.disabled = false
    }catch(err){
      ceBox.textContent = 'Fetch error: ' + err.message
      peBox.textContent = ''
    }
  }

  async function doPostPicks(){
    const base = getBase()
    let instruments = []
    try{
      instruments = instrumentsTA.value ? JSON.parse(instrumentsTA.value) : []
      if(!Array.isArray(instruments)) throw new Error('Not an array')
    }catch(err){
      alert('Invalid instruments JSON: ' + err.message)
      return
    }
    const body = { instruments: instruments, min_price: Number(minPriceEl.value||0), max_price: Number(maxPriceEl.value||9999) }
    const url = base + '/api/pick_strikes'
    ceBox.textContent = 'posting...'
    peBox.textContent = 'posting...'
    savePicks.disabled = true
    try{
      const r = await fetch(url, {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body)})
      if(!r.ok){ const txt = await r.text(); ceBox.textContent = 'Error: ' + r.status + '\n' + txt; peBox.textContent=''; return }
      const j = await r.json()
      lastPicks = j
      ceBox.textContent = JSON.stringify(j.CE, null, 2)
      peBox.textContent = JSON.stringify(j.PE, null, 2)
      savePicks.disabled = false
    }catch(err){ ceBox.textContent = 'Post error: ' + err.message; peBox.textContent = '' }
  }

  async function doSavePicks(){
    if(!lastPicks) return alert('No picks to save')
    const base = getBase()
    const payload = { selected_strikes: { ce: lastPicks.ce || lastPicks.CE || null, pe: lastPicks.pe || lastPicks.PE || null } }
    try{
      const r = await fetch(base + '/api/save_selected_strikes', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload) })
      if(!r.ok){ const t = await r.text(); alert('Save error: ' + r.status + '\n' + t); return }
      const j = await r.json()
      alert('Saved selected_strikes')
    }catch(err){ alert('Save error: ' + err.message) }
  }

  async function doSaveConfig(){
    const base = getBase()
    // fetch existing config, merge
    try{
      const getr = await fetch(base + '/api/config')
      let cfg = {}
      if(getr.ok){ const gj = await getr.json(); cfg = gj.config || {} }
      cfg.lots = Number(lotsEl.value||1)
      cfg.lot_size = Number(lotSizeEl.value||75)
      const r = await fetch(base + '/api/save_config', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ config: cfg }) })
      if(!r.ok){ const t = await r.text(); alert('Save config error: ' + r.status + '\n' + t); return }
      const j = await r.json()
      configOut.textContent = JSON.stringify(j.saved || j, null, 2)
      alert('Config saved')
    }catch(err){ alert('Save config error: ' + err.message) }
  }

  async function doShowConfig(){
    const base = getBase()
    try{
      const r = await fetch(base + '/api/config')
      if(!r.ok){ configOut.textContent = 'Err: ' + r.status; return }
      const j = await r.json()
      configOut.textContent = JSON.stringify(j.config || j, null, 2)
      // populate UI if present
      if(j.config){ if(j.config.lots) lotsEl.value = j.config.lots; if(j.config.lot_size) lotSizeEl.value = j.config.lot_size }
    }catch(err){ configOut.textContent = 'Fetch config error: ' + err.message }
  }

  fetchPicks.addEventListener('click', doFetchPicks)
  savePicks.addEventListener('click', doSavePicks)
  loadConfig.addEventListener('click', doShowConfig)
  postPickBtn.addEventListener('click', doPostPicks)
  saveConfigBtn.addEventListener('click', doSaveConfig)
  showConfigBtn.addEventListener('click', doShowConfig)

})();
</script>
</body>
</html>
